---
// Loader.astro
---

<div class="loader" id="loader">
  <div class="loader__content">
    <img src="/logo.svg" alt="Hot Lava" class="loader__logo" />
    <div class="loader__spinner"></div>
  </div>
</div>

<script>
  import { waitForAssets } from '../scripts/utils/images-ready.js';

  // Wait for fonts and critical images to load before removing loader
  async function initLoader() {
    const loader = document.getElementById('loader');
    if (!loader) return;

    const startTime = Date.now();
    const minDisplayTime = 1500; // 1.5 segundos m√≠nimo

    try {
      // Wait for both fonts and critical images
      await new Promise<void>((resolve) => {
        waitForAssets(() => {
          resolve();
        });
      });
      
      // Additional wait to ensure everything is fully rendered
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // Calculate remaining time to ensure minimum display time
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, minDisplayTime - elapsed);
      
      // Wait for remaining time if needed
      if (remaining > 0) {
        await new Promise(resolve => setTimeout(resolve, remaining));
      }
      
      // Remove loader
      loader.classList.add('loader--hidden');
      
      // Mark that assets are ready and dispatch custom events
      (window as any).fontsReadyDispatched = true;
      window.dispatchEvent(new CustomEvent('fontsReady'));
      window.dispatchEvent(new CustomEvent('assetsReady'));
      
      // Remove loader from DOM after animation
      setTimeout(() => {
        loader.remove();
      }, 500);
      
    } catch (error) {
      console.warn('Asset loading error:', error);
      // Even if there's an error, ensure minimum display time
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, minDisplayTime - elapsed);
      
      setTimeout(() => {
        loader.classList.add('loader--hidden');
        (window as any).fontsReadyDispatched = true;
        window.dispatchEvent(new CustomEvent('fontsReady'));
        window.dispatchEvent(new CustomEvent('assetsReady'));
        setTimeout(() => loader.remove(), 500);
      }, remaining);
    }
  }

  // Initialize loader when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLoader);
  } else {
    initLoader();
  }
</script>

<style>
  .loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background-color: var(--color-darkBlue, #103B60);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
  }

  .loader--hidden {
    opacity: 0;
    transform: translateY(-100%);
    transition: opacity 0.95s ease-out, transform 0.5s ease-out;
    pointer-events: none;
  }

  .loader__content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;

    width: 100%;
  }

  .loader__logo {
    width: min(100%, 90px);
    height: auto; 
    display: block;
  }

  .loader__spinner {
    width: 32px;
    height: 32px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-top-color: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

